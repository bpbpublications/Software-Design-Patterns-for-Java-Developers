const h = require('http')
function parse(q, r, cb) {
  let data = ''
  q.on('data', (d) => {
    data += d
  })
  q.on('end', () => {
    data = data.toString()
    const delim = data.split("\r")[0]
    let file = data.split('filename')[1]
    file = file.split('\r')[0]
    file = file.replace(/\"/g, '')
    file = file.replace(/=/g, '')
    let rest = data.split('\r\n\r\n')[1]
    let content = rest.split('\r\n')[0].trim()
    cb(file, content)
  })
}
const s = h.createServer((q, r) => {
  if (q.url === '/upload') {
    parse(q, r, (name, data) => {
      r.end(`got ${name} with content ${data}`)
    })
  } else {
    const form = '<form action="/upload" ' +
    'enctype="multipart/form-data" method="post"> '+
    '<input type="file" name="upload"> ' +
    '<input type="submit" value="submit"> '+
    '</form>'
    r.end(form)
  }
})
s.listen(12000)
